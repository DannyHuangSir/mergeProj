<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">

<head>
	<th:block th:replace="fragments/head"/>
	<title>已持有投資標的轉換｜臺銀人壽保單網路服務</title>
</head>

<body>
	<div th:replace="fragments/header :: top"></div>
	<header th:replace="fragments/header :: header"></header>
	<th:block th:if="${showUserDataInfo}">
		<div th:replace="fragments/header :: alert_mobile"></div>
		<div th:replace="fragments/header :: alert_container"></div>
		<div th:replace="fragments/header :: compensation_processing"></div>
		<div th:replace="fragments/header :: compensation_incomplete"></div>
		<div th:replace="fragments/header :: application_processing"></div>
		<div th:replace="fragments/header :: application_complete"></div>
		<div th:replace="fragments/header :: compensation_complete"></div>
		<div th:replace="fragments/header :: payment_notification"></div>
		<div th:replace="fragments/header :: payonline_template"></div>
	</th:block>
	<!--major 3 tabs-->
	<div th:replace="fragments/header :: majorTabs (funId='apply1')"></div>
	<section class="grey applyInner fullContent">
		<div class="container bg3">
			<ul class="breadcrumb detail1">
				<li>
					<a href="apply1">線上申請</a> <i class="fa fa-angle-right fa-lg ble"></i>
				</li>
				<li class="active">
					<a href="javascript:;">已持有投資標的轉換</a>
				</li>
			</ul>
		</div>
		<div class="container bg3 box-border">
			<div class="tb3 top0 nopd">
				<i class="fas fa-edit"></i> 已持有投資標的轉換
			</div>
			<div class="">
				<ul class="step">
					<li class="step1  col-xs-2">
			            1<span class="hid1">. 選擇保單</span>
			        </li>
			        <li class="step2  col-xs-2">
			            2<span class="hid1">. 接受條件</span>
			        </li>
			        <li class="step3b  col-xs-2">
			            3<span class="hid1">. 選擇轉出基金</span>
			        </li>
			        <li class="step3b active col-xs-3">
			            4<span class="hid1">. 選擇轉入基金</span>
			        </li> 
			        <li class="step4   col-xs-3">
			            5<span class="hid1">. 確認資料與密碼</span>
			        </li>
				</ul>
			</div>
			<div class="mystyle3">
				<h2>設定新投資標的比例</h2>
				<div class="loan1">
					<div class="tb3 top0">
						<!-- <span class="pull-left chMiddle colorBlack">可轉入金額：<span class="chNormal">NTD </span><span class="colorBlue" >
							<th:block th:text="${investmentPortfolioVo != null} ? ${investmentPortfolioVo[0].safpNetAmt}:''"/>
						</span></span> -->
						<span class="pull-right colorBlack">投資風險屬性：<span class="colorBlue" >
							<th:block th:text="${investmentPortfolioVo != null} ? ${investmentPortfolioVo[0].invtRiskBeneLevel}:''"/>	
						</span></span>
					</div>

					<div class="check-title">新投資標的比例</div>
					<div class="plus-list">
						<div class="col-sm-6">新投資標的</div>
						<div class="col-sm-3"></div>
						<div class="col-sm-2">輸入百分比</div>
						<div class="col-sm-1"></div>
					</div>

					<div class="check-body grey2">
						<div id="fundContent">
							 <!-- <div class="check-list2 newfund">
								<div style="width: 100%;display: inline-block;">
									<div class="col-sm-2">
										<div class="selector-box">
											<select class="selector">
												<option>基金公司</option>
												<option> </option>
												<option> </option>
												<option> </option>
											</select>
										</div>
									</div>
									<div class="col-sm-2">
										<div class="selector-box">
											<select class="selector">
												<option>基金幣別</option>
												<option>人民幣</option>
												<option>臺幣</option>
											</select>
										</div>
									</div>
									<div class="col-sm-2">
										<div class="selector-box">
											<select class="selector">
												<option>基金類型</option>
												<option> </option>
												<option> </option>
												<option> </option>
											</select>
										</div>
									</div>
								</div>
								<div class="col-sm-6">
									<div class="selector-box">
										<select class="selector">
											<option>瀚亞投資-印尼股票基金A <span>(CPEDU)</span></option>
											<option>瀚亞投資-印尼股票基金A <span>(CPEDU)</span></option>
											<option>瀚亞投資-印尼股票基金A <span>(CPEDU)</span></option>
											<option >瀚亞投資-印尼股票基金A <span>(CPEDU)</span></option> 
										</select>
									</div>
								</div>
								<div class="col-sm-3"><a href="#" class="inv2">我要瞭解基金內容</a></div>
								<div class="col-sm-2 r1"><input type="text" class="col-sm-10">%</div>
								<div class="col-sm-1">
									<a class="btn-cancel" onclick="removeInvestmentList(this)">删除</a>
								</div>
							</div>  -->
						</div>

						<div class="check-list2 center1">
							<button class="btn-login invst2btn" id="add-check-list"    onclick="addInvestment()"><i class="fa fa-plus-circle fa-lg"></i> 新增投資標的</button>
						</div>
						<div class="invst2total"> 總百分比 : <span id="showConutPercentage">0</span> %</div>
							<!-- TAB 2 -->
						<article class="tab" id="tab_4" style="display: none;">
							<!-- <article class="tab" id="tab_4" > -->
							<section id="tab_frame_print1" class="tab-frame">
									<div class="arrow-upleft"></div>
									<div class="grey2">
										<div class="check-title depo2">帳戶內容</div>
										<div class="check-list2 grey2">
											<label for="" class="col-sm-3">Swift Code</label>
											<div class="col-sm-9"><input placeholder="臺幣保單不需輸入" id="swiftCode" type="text" class="col-sm-6"> </div>
										</div>
										<div class="check-list2 grey2">
											<label for="" class="col-sm-3">英文戶名</label>
											<div class="col-sm-9"><input placeholder="臺幣保單不需輸入" id="englishName" type="text" class="col-sm-6"> </div>
										</div>
										<div class="check-list2 grey2">
											<label for="" class="col-sm-3">帳戶名稱</label>
											<div class="col-sm-8 gray">
												<th:block th:text="${proposer}"/>
												<input type="hidden" id="accountName" name="accountName" th:value="${proposer}"/>
											</div>
										</div>
										<div class="check-list2 grey2">
											<label for="" class="col-sm-3">銀行名稱</label>
											<div class="col-sm-3">
												<div class="selector-box">
													<select class="selector" id="bankOpt" name="bankOpt">
													</select>
												</div>
											</div>
											<label for="" class="col-sm-2">分行名稱</label>
											<div class="col-sm-3">
												<div class="selector-box">
													<select class="selector" id="brancheOpt" name="brancheOpt" >
													</select>
												</div>
											</div>
										</div>
										<div class="check-list2 grey2">
											<label for="" class="col-sm-3">帳號</label>
											<div class="col-sm-9"><input type="text" id="bankAccount" class="col-sm-11"> </div>
										</div>
									</div>
							</section>
						</article>
						<div class="statement1 wht">
							<p class="text-ps">備註：</p>
							<ol class="text-ps" id="parameterValueByProportionFund4">
								<li>未來保費投資標的申請如於當日15:00提出申請則視為當日申請，逾時則視為次一工作日申請。</li>
								<li>相同標的不得同時申請投資標的部分提領及投資標的轉換。</li>
								<li>申請『投資標的轉換』之保單，如果仍有已申請但未完成的交易項目，須待前一交易完成後方可提出。</li>
								<li>各投資標的之配置比例必須為10的倍數且總和需為 100%。</li>
								<li>本保單投資標的總數以10 個為上限，每次交易最多得同時選擇10個投資標的做為未來繳入保費的投資配置項目。</li>
								<li>已持有標的轉換後，如未來保費投資標的也要轉換時，則必須再做未來保費投資配置變更。</li>
								<li>新約定投資標的之風險屬性須符合要保人最新風險屬性等級，如前次所作風險屬性等級評估已達1年以上，須重新評估要保人之風險屬性等級，並作為日後變更投資標的申請之依據。</li>
								<li>如新約定投資標的非屬保守型，且距前次所作風險屬性等級評估已達1年以上，須重新評估要保人之風險屬性等級，並作為日後變更投資標的申請之依據。</li>
								<li>您於指定投資標的前，應充分瞭解下列以投資高收益債券為訴求之基金之特有風險：(1)信用風險：由於高收益債券之信用評等未達投資等級或未經信用評等，可能面臨債券發行機構違約不支付本金、利息或破產之風險。(2)利率風險：由於債券易受利率之變動而影響其價格，故可能因利率上升導致債券價格下跌，而蒙受虧損之風險，高收益債亦然。(3)流動性風險：高收益債券可能因市場交易不活絡而造成流動性下降，而有無法在短期內依合理價格出售的風險。(4)如要保人指定以高收益債券為訴求之基金為投資標的者，不宜占其投資組合過高之比重，且不適合無法承擔相關風險之要保人。(5)若高收益債券基金為配息型，基金的配息可能由基金 的收益或本金中支付。任何涉及由本金支出的部分，可能導致原始投資金額減損。部分基金進行配息前未先扣除行政管理相關費用。(6)高收益債券基金可能投資美國144A債券（境內基金投資比例最高可達基金總資產30%；境外基金不限），該債券屬私募性質，易發生流動性不足，財務訊息揭露不完整或價格不透明導致高波動性之風險。</li>
							</ol>
						</div>


					</div>

				</div>
			</div>
			<div class="col-md-12 two-buttons">
				<a href="javascript:void(0);"><button id="deny" class="btn-signup">上一步</i></button></a>
				<a href="javascript:void(0);"><button id="go" class="btn-signup">下一步</i></button></a>
			</div>
		</div>
	</section>
	<footer th:replace="fragments/footer"></footer>
	<th:block th:replace="fragments/script"/>
	<script th:inline="javascript">
	/*<![CDATA[*/
		var investmentPortfolioVoList = /*[[${investmentPortfolioVo}]]*/;
		var chckSwiftCode = /*[[${chckSwiftCode}]]*/;
		//銀行下拉選單
		var bankUrl = /*[[@{/getBankList}]]*/;
			var branchesUrl = /*[[@{/getBranchesList}]]*/;
			eserviceOption.bankBranches('#bankOpt', bankUrl, '#brancheOpt', branchesUrl);

		$(function() {
			//獲取條款備注信息
		var parameterValueByProportion = /*[[${parameterValueByProportion}]]*/;
			if (parameterValueByProportion!= undefined && parameterValueByProportion != null && parameterValueByProportion != ''){
			$("#parameterValueByProportionFund4").html(parameterValueByProportion);
			}
			//搜索选项
			initSearchItems();
		initNewInvestments();
		//根據保單號或者保單類型獲取最大小值
		investmentLimitSize();
			//公司选项变更
			$("body").on('change', "[name='companysItem']", function(){
				filterAndRestItems($(this).parent().parent().parent().parent())
			})
			//币别选项变更
			$("body").on('change', "[name='currencysItem']", function(){
				filterAndRestItems($(this).parent().parent().parent().parent())
			})
			//基金选项变更
			$("body").on('change', "[name='invSelect']", function(){
				$(this).parent().parent().parent().find("[name='toUri']").attr("href", [[${uri}]] + $(this).val())
				showOrHideAccount();
			})
		});
	//獲取當前保單的新投資標的數據	
	var newInvestments
	function initNewInvestments() {
		let ownInvtNos = []
		let  policyNo="";
		if(investmentPortfolioVoList!=null){
			policyNo=investmentPortfolioVoList[0].policyNo
		}
		investmentPortfolioVoList.forEach(element => {
			if (element.number > 0) {
				ownInvtNos.push({invtNo: element.invtNo})
			}
		});
		let data = {policyNo: policyNo, ownInvestments: ownInvtNos}
		//let data = {policyNo: policyNo}
		$.ajax({
				type : 'POST',
				contentType : 'application/json',
				url : /*[[@{/fund4NewInvestments}]]*/,
				data : JSON.stringify(data),
				success : function(response) {
					if(response.result == "ERROR") {
						openAlert(response.resultMsg);
					} else {
						newInvestments = response.resultData
					}
				},
				error : function() {
					/* openAlert('系統發生錯誤!'); */
					openAlert($('#E0018').val());
				}
			});
	}
	var investmentInputSize;
	//根據保單號或者保單類型獲取最大小值
	//傳其中一個即可(保單號 ||  保單類型)
	function  investmentLimitSize(){
		let  policyNo="";
		if(investmentPortfolioVoList!=null){
			policyNo=investmentPortfolioVoList[0].policyNo
		}
		let data = {policyNo: policyNo}
		$.ajax({
				type : 'POST',
				contentType : 'application/json',
				url : /*[[@{/investmentRatioSizeLimit}]]*/,
				data : JSON.stringify(data),
				success : function(response) {
					if(response.result == "ERROR") {
						openAlert(response.resultMsg);
					} else {
						investmentInputSize = response.resultData
					}
				},
				error : function() {
					/* openAlert('系統發生錯誤!'); */
					openAlert($('#E0018').val());
				}
			});
	}
	//獲取公司與幣別數據信息
	var companysItems = []
	var currencysItems = []
	function initSearchItems() {
		$.ajax({
			type : 'POST',
			contentType : 'application/json',
			url : /*[[@{/getInvestmentConversionSearchItem}]]*/,
			data : JSON.stringify({policyNo: investmentPortfolioVoList[0].policyNo}),
			success : function(response) {
				if(response.result == "ERROR") {
					openAlert(response.resultMsg);
				} else {
					companysItems = response.resultData.companys
					currencysItems = response.resultData.currencys
					currencysItems.unshift({KEY: '依基金幣別查詢', VALUE: 'ALL'})
				}
			},
			error : function() {
				openAlert($('#E0018').val());
			}
		});
	}
	//將新投資標的數據進行顯示
	function addInvestment(){
			//根据保单号，持有基金查询可转入基金
			var item = '<div class="check-list2 newfund" id="investment_template">'
              +'<div style="width: 100%;display: inline-block;">'
                             /* +'<div class="col-sm-2">'
                           +' <div class="selector-box">'
                            +'  <select name="companysItem" class="selector">'
								$(companysItems).each(function(index, e){
								if (e != null) {
									item += '<option value="' + e.VALUE +  '"> ' + e.KEY + '</option>'
								}
								})
							item = item +' </select>'
                            +'</div>'
                         +' </div>'
						 */
                         +' <div class="col-sm-2">'
                          +'  <div class="selector-box">'
                          +'    <select  name="currencysItem" class="selector">'
								$(currencysItems).each(function(index, e){
								 if (e != null) {
									item += '<option value="' + e.VALUE +  '"> ' + e.KEY + '</option>'
								 }
						 		})
							 item = item + '    </select>'
                          +'  </div>'
                         +' </div>'
                          +'</div>'
                         +'<div class="col-sm-6">'
                         +'   <div class="selector-box">'
                         +'     <select class="selector" name="invSelect" >'
						$(newInvestments).each(function(index, e){
							if (e != null) {
								item += '<option  invtName="' + e.invtName + '" value="' + e.invtNo +  '"> ' + e.invtName +' <span>(' + e.invtNo + ')</span></option>'
							}
						})
						item = item +'</select>'
                         +'  </div>'
                         +' </div>'
                         +'       <div class="col-sm-3"><a target="_blank" name="toUri" href="#" class="inv2">我要瞭解基金內容</a></div>'

                         +'       <div class="col-sm-2"><input type="text" onblur="showNumberPercentage(this)"  name="ratio" max="'+investmentInputSize.ratioMaxSize+'" min="'+investmentInputSize.ratioMinSize+'" class="col-sm-10" value="0">%</div>'
                         
						 +'       <div class="col-sm-1">'
						 +'       	<a class="btn-cancel" onclick="removeInvestmentList(this)">删除</a>'
						 +'       </div>'
                         +'       <div class="clearfix"></div>'
                         +' </div> '
    		$('#fundContent').append(filterAndRestItems($(item)));
			showOrHideAccount();
    	}
	
		function filterAndRestItems(vm) {
			arr = $(newInvestments)
				/*.filter(function(index, e) {
				return e.company == $(vm).find("[name='companysItem'] option:selected").val()
			})*/
			.filter(
				function(index, e) {
					let selectCurrency = $(vm).find("[name='currencysItem'] option:selected").val()
					return selectCurrency == 'ALL' || e.invtExchCurr == selectCurrency
				}
			)
			let html = ''
			var isFirst = true
			$(arr).each(function(index, e){
				if (isFirst) {
					$(vm).find("[name='toUri']").attr("href", [[${uri}]] + e.invtNo)
					isFirst = false
				}
				html += '<option   invtName="' + e.invtName + '" value="' + e.invtNo +  '"> ' + e.invtName +' <span>(' + e.invtNo + ')</span></option>'
			})
			$(vm).find("[name='invSelect']").html(html)
			showOrHideAccount();
			return $(vm)
		}
		//刪除新投資標的欄目
    	function removeInvestmentList(obj){
    		$(obj).parent().parent('.newfund').remove();
			let  va=	$(obj).parent().parent('.newfund').find("input[name='ratio']").val();
			console.log('-----va---------',va);
			let  j=	$("#showConutPercentage").text();
			let  i=parseInt(j)-parseInt(va);
		   $("#showConutPercentage").text(i);
    	}
		//計算百分比
		function showNumberPercentage(obj){
			console.log('-----Output---------',obj);
			//var  showOutputDate=0;
			var  showObj=   $(obj).val();
				console.log('-----showObj---------',showObj);
					if(showObj>0 && showObj<investmentInputSize.ratioMinSize){
						let minMessage="新投資標的轉入百分比不能小於"+investmentInputSize.ratioMinSize+"%";
						openAlert(minMessage);
						//$(obj).val(investmentInputSize.ratioMinSize);
					} else  if(showObj>investmentInputSize.ratioMaxSize){
						let maxMessage="新投資標的轉入百分比不能大於"+investmentInputSize.ratioMaxSize+"%";
						openAlert(maxMessage);
						//$(obj).val(investmentInputSize.ratioMaxSize);
					}
					if(showObj%10!=0){
						openAlert("新投資標的轉入百分比只能輸入10的倍數");
					}
				//進行循環獲取其他的input的百分比		
					//var numArr = new Array();
					let  i=0;
				$("input[name='ratio']").each(function(){
          			 // numArr.push($(this).val());//添加至数组
					i+=parseInt($(this).val());
					if(i>100){
						openAlert("當前保單新投資標總百分比不能大於100%,還請調整其他基金百分比.");
					}				
       			 });
				if(i>100){
					openAlert("當前保單新投資標總百分比不能大於100%,還請調整其他基金百分比.");
					i=100;
					return  false;
				}		
				//設置百分比
			$("#showConutPercentage").text(i);
			};	
		//進行驗證當前賬戶的投資標是否為商品顯示賬戶
		function showOrHideAccount() {
		let show = false
		$("#fundContent").children().each(function(index, e) {
			let invtNo = $(e).find("[name='invSelect'] option:selected").val()
			if (chckSwiftCode.indexOf(invtNo) != -1) {
				$("#tab_4").show()
				show = true
			}
		})
		if (!show) {
			$("#tab_4").hide()
		}
	}	
    //進行驗證提交時所有的百分比不能超過100
		function  inputValidation(){
			 let  j=0;
			$("input[name='ratio']").each(function(){
					j+=parseInt($(this).val());			
       			 });
			 if( j>100 || j<100 ){
				return false;
			  }		
			return  true;		
		}	
	//進行計算每個百分比不能輸入為0	
		function  inputValidationMin(obj){
			var boo = true;
			 for(var i=0; i<obj.length; i++){
				console.log("111111111",obj[i].ratio);
					if(obj[i].ratio<1){
						boo = false;
						 break;
					}
			 }
			 return  boo;	
		}
		//百分比只允許輸入10的倍數
		function  inputValidationMultiple(obj){
			var boo = true;
			 for(var i=0; i<obj.length; i++){
				console.log("111111111",obj[i].ratio);
					if(obj[i].ratio % 10 !=0){
						boo = false;
						 break;
					}
			 }
			 return  boo;	
		}	
	//驗證基金部不能重複
	function  fundValidation(obj){
		var boo = true;
			for(var i=0; i<obj.length; i++)
			{
				for(var j=i+1; j<obj.length;j++)
				{
					if(obj[i].invtNo==obj[j].invtNo){
						 boo = false;
						 break;
					}
				}
			}
			return  boo;		
		}
	//進行判斷帳戶內容
	function  fundValidationAccount(obj){
		let invtNo="";
		let show = false
			$("#fundContent").children().each(function(index, e) {
				let invtNo = $(e).find("[name='invSelect'] option:selected").val()
				if (chckSwiftCode.indexOf(invtNo) != -1) {
					show = true
				}
			})
			if(show){
				if ([[${policyListPolicyNo.currency}]]!= 'NTD') {
					if ($('#swiftCode').val() == '') {
						openAlert("請輸入Swift Code");
						return   false;
						}
					if ($('#englishName').val() == '') {
						openAlert("請輸入英文戶名");
						return  false;
					}
				}
				if($('#bankOpt').val() == '') {
					openAlert("請選擇銀行");
					return false;
				}
				if ($('#brancheOpt').val() == '') {
					openAlert("請選擇分行");
					return false;
				}
				if ($('#bankAccount').val() == '') {
					openAlert("請輸入帳號");
					return false;
				}
				if (!/^\d+$/.test($('#bankAccount').val())) {
					openAlert('銀行帳號僅為數字');
					openAlert($('#E0053').val());
					return false;
				}
			}
		return  true;
	}
	//提交点击下一步
		$("#go").click(function(){
			 	if(!inputValidation()){
					openAlert("當前保單新投資標總百分比之和不是100%,還請調整其他基金百分比.");
					return false;
				 }	
				var formData = {};
				var numArr = new Array();
				var numInvestment = [];
				$("#fundContent").children().each(function(index, e) {
					let sel = $(e).find("[name='invSelect'] option:selected")
					numInvestment.push({"invtName": sel.attr("invtName"), "invtNo": sel.val(), "ratio": $(e).find("input[name='ratio']").val(), "policyNo": investmentPortfolioVoList[0].policyNo});
				})	
				if(!fundValidation(numInvestment)){
					openAlert("當前保單新投資標不能重複選擇,還請重新選擇");
					return false;
				}
				//console.log("111111111",!inputValidationMin(numInvestment));
				 if(!inputValidationMin(numInvestment)){
					openAlert("當前保單新投資標中有百分比之為0%,還請基金百分比.");
					return false;
				 }
				 //百分比只允許輸入10的倍數
				 if(!inputValidationMultiple(numInvestment)){
					openAlert("當前保單新投資標中有百分比不是10的倍數");
					return false;
				 }
				 if(!fundValidationAccount(formData)){
					return false;
				 }
				 let show = false
				$("#fundContent").children().each(function(index, e) {
					let invtNo = $(e).find("[name='invSelect'] option:selected").val()
					if (chckSwiftCode.indexOf(invtNo) != -1) {
						show = true
					}
				})
				if(show){
					formData.bankAccount = $('#bankAccount').val();
					formData.bankName = $('#bankOpt option:selected').text();
					formData.bankCode = $('#bankOpt option:selected').val();
					formData.branchName = $('#brancheOpt option:selected').text();
					formData.branchCode = $('#brancheOpt option:selected').val();
					formData.englishName = $('#englishName').val();
					formData.swiftCode = $('#swiftCode').val();
					formData.accountName = $('#accountName').val();
				}
				//console.log('-----newObj---------',numInvestment);
				formData.numInvestment = JSON.stringify(numInvestment);
				formData.investmentsList = JSON.stringify(investmentPortfolioVoList);
				formData.currency = [[${policyListPolicyNo.currency}]]
				postWithFormData(/*[[@{/fund5}]]*/, formData);
		});
		//回退上上一步
		$("#deny").click(function(){	
				var formData = {};
				formData.currency = [[${policyListPolicyNo.currency}]]
				formData.policyNo=investmentPortfolioVoList[0].policyNo;
				postWithFormData(/*[[@{/fund3}]]*/, formData);
		});
	/*]]>*/
	</script>
</body>

</html>