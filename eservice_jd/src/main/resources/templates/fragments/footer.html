<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<!--   Core JS Files   -->
<script th:src="@{/plugin/jquery-1.11.3.min.js}"></script>
<script th:src="@{/plugin/bootstrap.min.js}"></script>
<script th:src="@{/plugin/bootstrap-datepicker.min.js}"></script>

<script th:src="@{/js/eservice/demo.js}"></script>
<!-- jQuery UI -->
<script th:src="@{/plugin/jquery-ui.min.js}"></script>
<!-- jQuery Scrollbar -->
<script th:src="@{/plugin/jquery.scrollbar.min.js}"></script>
<!-- Chart JS -->
<script th:src="@{/plugin/chart.min.js}"></script>
<!-- tablesaw -->
<script th:src="@{/js/atlantis.js}"></script>
<script th:src="@{/plugin/tablesaw.stackonly.js}"></script>
<!--popover-->
<script th:src="@{/plugin/scrollbar.js}"></script>
<script th:src="@{/js/popover-callback.js}"></script>
<script th:src="@{/js/eservice/timer.js}"></script>
<script th:src="@{/plugin/timer.jquery.js}"></script>
<script th:inline="javascript">
/*<![CDATA[*/
    document.oncontextmenu = function() {
        return false
    }

    var currentPageId = sessionStorage.getItem("localId")
    var sessionPageId = /*[[${session.SESSION_PAGE_ID}]]*/
    if (currentPageId == null && sessionPageId == null) {
        var uuid = crypto.randomUUID()
        $.post(/*[[@{/bindSessionPage}]]*/,  {
            uuid: uuid
        })
        sessionStorage.setItem("localId", uuid);
    } else if ((currentPageId == null && sessionPageId != null) || (currentPageId != null && sessionPageId != null && currentPageId != sessionPageId)) {
        alert("不允許打開新分頁");
        sessionStorage.clear()
        window.location.href = /*[[@{/doLogout}]]*/
    } else if (currentPageId != null && sessionPageId == null) {
        $.post(/*[[@{/bindSessionPage}]]*/,  {
            uuid: currentPageId
        })
    }
/*]]>*/
</script>
<script th:inline="javascript">
/*<![CDATA[*/
    pageNum = 1
    notifySearchStatus = null
    notifySearchTime = null
    msgMap = {}
    function clickSearch() {
        event.preventDefault(),
		event.stopPropagation();
        $("#messageContent").html("<div class='items' id='messages' style='overflow-y: hidden;'></div>")
        pageNum = 1
        notifySearchStatus = $('#notifyStatus option:selected').val()
        notifySearchTime = $('#notifySearchTime').val() == '' ? null : $('#notifySearchTime').val()
        appendNotifyItems(true)
        return false;
    }

    function popoverCallback() {
        pageNum += 1
        appendNotifyItems()
    }

    function appendNotifyItems(config = false) {
        $.ajax({
            type : 'POST',
            contentType : 'application/json',
            dataType : 'json',
            url : /*[[@{/message}]]*/,
            data: JSON.stringify(
                {
                    pageSize: 50,
                    pageNum: pageNum,
                    status: notifySearchStatus,
                    notifySearchTime: notifySearchTime
                }
            ),
            success : function(data) {
                if (data.result = 'SUCCESS') {
                    $('#messageCount').text(data.resultData.count)
                    $(data.resultData.data).each(function(index, item){
                        msgMap[item.id] = {
                            msg: item.msg,
                            title: item.title
                        }
                        $('#messages').append(
                            '<a href="#" class="item" onclick=\'msgDetail(' + item.id + ')\'>' +
                                '<div class="header"><em>' + item.title + '</em></div>' +
                                '<div class="content text-right"><small>' + item.notifyTime + '</small></div>' +
                             '</a>'
                        )
                    })
                }
                if (!config) {
                    $("#messages").mCustomScrollbar("destroy")
                }
                 $("#messages").height("200px").mCustomScrollbar({
<!--                         callbacks:{-->
<!--                                onTotalScroll:function() {-->
<!--                                    popoverCallback()-->
<!--                                }-->
<!--                            }-->
                    })
            }
        });
    }

    function getNotRead() {
        $.ajax({
            type : 'POST',
            contentType : 'application/json',
            dataType : 'json',
            url : /*[[@{/getNotRead}]]*/,
            success : function(data) {
                if (data.result = 'SUCCESS') {
                    $('#notRead').text(data.resultData)
                }
            }
        });
    }

    function msgDetail(id) {
        $('#msg-modal .title').text(msgMap[id].title)
        $('#msg-modal .content').html(msgMap[id].msg)
        $('#msg-modal').modal({
            show: true,
            backdrop: 'static',
            keyboard: false
        });
        $.ajax({
            type : 'POST',
            contentType : 'application/json',
            dataType : 'json',
            url : /*[[@{/readNotifyMsg}]]*/,
            data: JSON.stringify(
                {
                   id: id
                }
            )
        });
    }

    $(function(){
        appendNotifyItems()
        getNotRead()
        $("body").on('focus', '#notifySearchTime', function(){
            $(this).datepicker({
                dateFormat: 'yy-mm-dd',
            });
        })
   })

/*]]>*/
</script>
</body>
</html>