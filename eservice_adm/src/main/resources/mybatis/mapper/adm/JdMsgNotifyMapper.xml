<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.twfhclife.adm.dao.JdMsgNotifyDao">

    <insert id="addJdNotifyMsg">
        INSERT INTO ESERVICE_JD.DBO.MESSAGE(TITLE, MSG, STATUS, CREATE_DATE, USER_ID, NOTIFY_TIME)
        <if test="msg.users != null and msg.users.size() >0 ">
            values
            <foreach collection="msg.users" item="user" separator=",">
                (#{msg.title}, #{msg.msg}, '1', SYSDATETIME(), #{user}, #{msg.notifyTime})
            </foreach>
        </if>
        <if test="msg.deps != null and msg.deps.size() >0 ">
            SELECT #{msg.title}, #{msg.msg}, '1', SYSDATETIME(), UD.USER_ID, #{msg.notifyTime} from ESERVICE_JD.DBO.DEPARTMENT D
            INNER JOIN ESERVICE_JD.DBO.USER_DEPARTMENT UD ON D.DEP_ID = UD.DEP_ID
            WHERE D.DEP_ID IN
            <foreach collection="msg.deps" item="dep" separator="," close=")" open="(">
                #{dep}
            </foreach>
        </if>
        <if test="msg.roles != null and msg.roles.size() >0 ">
            SELECT #{msg.title}, #{msg.msg}, '1', SYSDATETIME(), UR.USER_ID, #{msg.notifyTime} FROM  ESERVICE_ADM.DBO.ROLE R
            INNER JOIN ESERVICE_ADM.DBO.USER_ROLE UR ON R.ROLE_ID = UR.ROLE_ID
            WHERE R.ROLE_ID IN
            <foreach collection="msg.roles" item="role" separator="," close=")" open="(">
                #{role}
            </foreach>
        </if>
    </insert>

    <insert id="addJdzqMsgSchedule">
        INSERT INTO ESERVICE_JD.dbo.NOTIFY_SCHEDULE(TITLE, MSG_CONTENT, USERS,  ROLES, DEPS, NOTIFY_TIME, CREATE_DATE, STATUS, NOTIFY_TARGET, PASSAGE_WAY)
        VALUES(#{msg.title}, #{msg.msg},
        <if test="msg.users != null and msg.users.size > 0">
            CONCAT('',
            <foreach collection="msg.users" separator="," item="u" index="idx">
                #{u}
                <if test="msg.users.size != (idx + 1)">
                    , ','
                </if>
            </foreach>
            )
        </if>
        <if test="msg.users == null or msg.users.size == 0">
           ''
        </if>
        ,
        <if test="msg.roles != null and msg.roles.size > 0">
            CONCAT('',
            <foreach collection="msg.roles" separator="," item="r" index="idx">
                #{r}
                <if test="msg.roles.size != (idx + 1)">
                    , ','
                </if>
            </foreach>
            )
        </if>
        <if test="msg.roles == null or msg.roles.size == 0">
            ''
        </if>
        ,
        <if test="msg.deps != null and msg.deps.size > 0">
            CONCAT('',
            <foreach collection="msg.deps" separator="," item="d" index="idx">
                #{d}
                <if test="msg.deps.size != (idx + 1)">
                    , ','
                </if>
            </foreach>
            )
        </if>
        <if test="msg.deps == null or msg.deps.size == 0">
            ''
        </if>
        , #{msg.notifyTime}
        , SYSDATETIME()
        , '1'
        , #{msg.notifyTarget}
        , #{msg.passageWay}
        )
    </insert>


    <select id="getJdzqMsgSchedule" resultType="hashmap">
        SELECT
         ID,
         TITLE
        ,CONVERT(VARCHAR, CREATE_DATE, 120) CREATE_DATE
        ,CONVERT(VARCHAR, NOTIFY_TIME, 120) NOTIFY_TIME
        ,NOTIFY_TARGET
        ,MSG_CONTENT
        ,STATUS
        FROM (
        SELECT
        ROW_NUMBER() OVER (ORDER BY CREATE_DATE) AS ROW_NUM
        ,A.*
        FROM (
        <include refid="INC1"/>
        ) A
        ) B
        WHERE
        B.ROW_NUM <![CDATA[<=]]> #{vo.page} * #{vo.rows}
        AND B.ROW_NUM <![CDATA[>]]> (#{vo.page} - 1) * #{vo.rows}
    </select>

    <select id="getJdzqMsgScheduleTotal" resultType="int">
        SELECT
        COUNT(1) AS AMOUNT
        FROM (
        <include refid="INC1"/>
        ) t
    </select>

    <sql id="INC1">
        SELECT
         d.ID,
         d.TITLE
        ,d.CREATE_DATE
        ,d.NOTIFY_TIME
        ,d.NOTIFY_TARGET
        ,d.MSG_CONTENT
        ,d.STATUS
        FROM
        ESERVICE_JD.DBO.NOTIFY_SCHEDULE d
        <where>
            <if test="vo.title != null and vo.title != ''">
                AND D.TITLE LIKE CONCAT('%', #{vo.title},'%')
            </if>

            <if test="vo.passageWay != null and vo.passageWay != ''">
                AND D.PASSAGE_WAY = #{vo.passageWay}
            </if>
        </where>
    </sql>

    <delete id="deleteNotifyMsg">
        DELETE FROM ESERVICE_JD.DBO.NOTIFY_SCHEDULE
        WHERE ID = #{id}
    </delete>

    <select id="getWillSendMsgs" resultType="com.twfhclife.adm.model.JdzqNotifyMsg">
        select ID id, TITLE title, MSG_CONTENT msg, USERS userStr, DEPS depStr, ROLES roleStr , NOTIFY_TIME notifyTime, CREATE_DATE createDate from
        ESERVICE_JD.DBO.NOTIFY_SCHEDULE WHERE NOTIFY_TIME &lt;= SYSDATETIME() AND STATUS = 1
    </select>

    <update id="updateNotifyMsgComplete">
        update ESERVICE_JD.DBO.NOTIFY_SCHEDULE
        set status = 2 where ID IN
        <foreach collection="ids" item="id" separator="," open="(" close=")">
            #{id}
        </foreach>
    </update>

</mapper>